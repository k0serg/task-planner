<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</title>
  <!-- PWA -->
  <link rel="manifest" href="/task-planner/manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#007bff">
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }
    body {
      background: #f4f6f8;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #1e1e1e;
      color: #eee;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input,
    select,
    button {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: space-between;
    }
    .filters select,
    .filters label {
      flex: 1 1 48%;
    }
    ul {
      list-style: none;
    }
    li {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 5px solid #007bff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    li:hover {
      transform: scale(1.01);
    }
    li.completed {
      text-decoration: line-through;
      opacity: 0.6;
      border-left-color: green;
    }
    li.overdue {
      border-left-color: red;
      background-color: #ffe6e6;
    }
    .task-title {
      font-weight: bold;
      font-size: 17px;
    }
    .task-time {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .task-no-deadline {
      color: #aaa;
      font-style: italic;
    }
    .task-category {
      font-size: 14px;
      color: #999;
      margin-top: 5px;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .checkbox {
      margin-right: 10px;
    }
    .btn-clear {
      margin-top: 10px;
      background: #dc3545;
    }
    .btn-clear:hover {
      background: #c82333;
    }
    .theme-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 20px;
      }
    }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js ';
    import { getDatabase, ref, set, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js ';

    // üîß –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project-id",
      databaseURL: "https://your-project-id.firebaseio.com ",
      storageBucket: "your-project.appspot.com",
      messagingSenderId: "your-sender-id",
      appId: "your-app-id"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ
    window.firebase = { database, ref, set, onValue, remove, update };
  </script>
</head>
<body>
  <button class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" onclick="toggleTheme()">üåô</button>
  <div class="container">
    <h1>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</h1>
    <form id="task-form">
      <input type="text" id="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required />
      <input type="datetime-local" id="task-time" />
      <select id="task-category">
        <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
        <option value="–õ–∏—á–Ω–æ–µ">–õ–∏—á–Ω–æ–µ</option>
      </select>
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>
    <div class="filters">
      <label>
        –°—Ç–∞—Ç—É—Å:
        <select id="filter-status">
          <option value="all">–í—Å–µ</option>
          <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
          <option value="active">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
        </select>
      </label>
      <label>
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
        <select id="filter-category">
          <option value="all">–í—Å–µ</option>
          <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
          <option value="–õ–∏—á–Ω–æ–µ">–õ–∏—á–Ω–æ–µ</option>
        </select>
      </label>
    </div>
    <ul id="task-list"></ul>
    <button class="btn-clear" onclick="clearCompleted()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
  </div>

  <script>
    const DB_NAME = "TaskPlannerDB";
    const STORE_NAME = "tasks";
    let db;
    function openDatabase() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = function(event) {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "id" });
          }
        };
        request.onsuccess = function(event) {
          db = event.target.result;
          resolve();
        };
        request.onerror = function(event) {
          console.error("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è IndexedDB");
          reject("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å IndexedDB");
        };
      });
    }

    function getOfflineTasks() {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], "readonly");
        const store = transaction.objectStore(STORE_NAME);
        const getAllRequest = store.getAll();
        getAllRequest.onsuccess = function(event) {
          resolve(event.target.result || []);
        };
        getAllRequest.onerror = function(event) {
          reject("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö");
        };
      });
    }

    function saveLocalTasks(data) {
      return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], "readwrite");
        const store = transaction.objectStore(STORE_NAME);
        const clearRequest = store.clear();
        clearRequest.onsuccess = () => {
          data.forEach(task => store.add(task));
        };
        transaction.oncomplete = resolve;
        transaction.onerror = reject;
      });
    }

    let tasks = [];

    async function loadTasks() {
      try {
        tasks = await getOfflineTasks();
        renderTasks();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á", e);
      }
    }

    function generateUniqueId() {
      return Math.random().toString(36).substring(2, 10);
    }

    async function addTask(title, time, category) {
      const newTask = {
        id: generateUniqueId(),
        title,
        time: time || null,
        category,
        done: false
      };
      tasks.push(newTask);
      await saveLocalTasks(tasks);
      setReminder(tasks.length - 1);
      renderTasks();

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Firebase
      if (window.firebase) {
        const taskRef = firebase.ref(firebase.database, `tasks/${newTask.id}`);
        await firebase.set(taskRef, newTask);
      }
    }

    async function deleteTask(index) {
      const taskId = tasks[index].id;
      tasks.splice(index, 1);
      await saveLocalTasks(tasks);
      renderTasks();

      // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
      if (window.firebase && taskId) {
        const taskRef = firebase.ref(firebase.database, `tasks/${taskId}`);
        try {
          await firebase.remove(taskRef);
          console.log("–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ Firebase:", taskId);
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ Firebase:", error);
        }
      }
    }

    async function toggleDone(index) {
      tasks[index].done = !tasks[index].done;
      await saveLocalTasks(tasks);
      renderTasks();

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Firebase
      if (window.firebase) {
        const taskId = tasks[index].id;
        const taskRef = firebase.ref(firebase.database, `tasks/${taskId}`);
        await firebase.update(taskRef, { done: tasks[index].done });
      }
    }

    async function clearCompleted() {
      const completedIds = tasks.filter(t => t.done).map(t => t.id);
      tasks = tasks.filter(t => !t.done);
      await saveLocalTasks(tasks);
      renderTasks();

      // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
      if (window.firebase) {
        for (const id of completedIds) {
          const taskRef = firebase.ref(firebase.database, `tasks/${id}`);
          await firebase.remove(taskRef);
        }
      }
    }

    function setReminder(index) {
      const task = tasks[index];
      if (!task.time) return;
      const dueDate = new Date(task.time);
      const now = new Date();
      const timeUntilDue = dueDate.getTime() - now.getTime();
      if (timeUntilDue > 0 && timeUntilDue < 24 * 60 * 60 * 1000) {
        setTimeout(() => {
          showNotification(task.title);
        }, timeUntilDue - 5 * 60 * 1000); // –∑–∞ 5 –º–∏–Ω—É—Ç
      }
    }

    function showNotification(title) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", {
          body: `–ó–∞–¥–∞—á–∞ "${title}" —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç!`,
          icon: "icon-192.png"
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            new Notification("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", {
              body: `–ó–∞–¥–∞—á–∞ "${title}" —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç!`,
              icon: "icon-192.png"
            });
          }
        });
      }
    }

    function renderTasks() {
      const statusFilter = document.getElementById("filter-status").value;
      const categoryFilter = document.getElementById("filter-category").value;
      const filteredTasks = tasks.filter(task => {
        let matchStatus = true;
        if (statusFilter === "completed") matchStatus = task.done;
        if (statusFilter === "active") matchStatus = !task.done;
        let matchCategory = true;
        if (categoryFilter !== "all") matchCategory = task.category === categoryFilter;
        return matchStatus && matchCategory;
      });
      const taskList = document.getElementById("task-list");
      taskList.innerHTML = "";
      filteredTasks.forEach((task, index) => {
        const now = new Date();
        const isOverdue = task.time && !task.done && new Date(task.time) < now;
        const li = document.createElement("li");
        li.className = task.done ? "completed" : isOverdue ? "overdue" : "";
        li.innerHTML = `
          <div class="task-title">${task.title}</div>
          <div class="task-time">
            ${task.time 
              ? 'üìÖ ' + new Date(task.time).toLocaleString() 
              : '<span class="task-no-deadline">–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞</span>'
            }
          </div>
          <div class="task-category">üìÇ ${task.category}</div>
          <div class="actions">
            <label><input type="checkbox" class="checkbox" ${task.done ? "checked" : ""} /> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            <button onclick="deleteTask(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        li.querySelector(".checkbox").addEventListener("change", () => {
          toggleDone(index);
        });
        taskList.appendChild(li);
      });
    }

    const taskForm = document.getElementById("task-form");
    taskForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const titleInput = document.getElementById("task-title");
      const timeInput = document.getElementById("task-time");
      const categoryInput = document.getElementById("task-category");
      const title = titleInput.value.trim();
      const time = timeInput.value ? new Date(timeInput.value).toISOString() : null;
      const category = categoryInput.value;
      if (!title) return;
      addTask(title, time, category);
      titleInput.value = "";
      timeInput.value = "";
    });

    setInterval(renderTasks, 60000); // —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É

    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    function loadRemoteTasks() {
      if (!window.firebase) return;
      const tasksRef = firebase.ref(firebase.database, 'tasks');
      firebase.onValue(tasksRef, (snapshot) => {
        const remoteTasks = snapshot.val();
        if (remoteTasks) {
          tasks = Object.values(remoteTasks); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤
          saveLocalTasks(tasks); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
          renderTasks();
        }
      });
    }

    window.addEventListener("load", async () => {
      await openDatabase(); // –û—Ç–∫—Ä—ã–≤–∞–µ–º IndexedDB
      const theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.body.classList.add("dark");
      }
      await loadTasks();
      loadRemoteTasks(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
    });

    window.addEventListener("online", () => {
      console.log("–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.");
    });
    window.addEventListener("offline", () => {
      console.log("–†–∞–±–æ—Ç–∞–µ–º –≤ –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ.");
    });

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/task-planner/sw.js")
          .then(registration => {
            console.log("Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", registration);
          })
          .catch(error => {
            console.log("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:", error);
          });
      });
    }

    document.getElementById("filter-status").addEventListener("change", renderTasks);
    document.getElementById("filter-category").addEventListener("change", renderTasks);
  </script>
</body>
</html>
