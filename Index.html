<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</title>

  <!-- PWA -->
  <link rel="manifest" href="/task-planner/manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#007bff">

  <style>
    /* –¢–æ—Ç –∂–µ CSS, —á—Ç–æ –∏ —Ä–∞–Ω–µ–µ ‚Äî –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é —Ä–∞–¥–∏ –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ */
    /* –°–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª */
  </style>
</head>
<body>
  <button class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" onclick="toggleTheme()">üåô</button>

  <div class="container">
    <h1>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</h1>

    <form id="task-form">
      <input type="text" id="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required />
      <input type="datetime-local" id="task-time" />
      <select id="task-category">
        <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
        <option value="–õ–∏—á–Ω–æ–µ">–õ–∏—á–Ω–æ–µ</option>
      </select>
      <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
    </form>

    <div class="filters">
      <label>
        –°—Ç–∞—Ç—É—Å:
        <select id="filter-status">
          <option value="all">–í—Å–µ</option>
          <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
          <option value="active">–ù–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
        </select>
      </label>
      <label>
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
        <select id="filter-category">
          <option value="all">–í—Å–µ</option>
          <option value="–†–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
          <option value="–õ–∏—á–Ω–æ–µ">–õ–∏—á–Ω–æ–µ</option>
        </select>
      </label>
    </div>

    <ul id="task-list"></ul>

    <button class="btn-clear" onclick="clearCompleted()">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js "></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js "></script>

  <script>
    // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase Console
    const firebaseConfig = {
      apiKey: "AIzaSyDvtrTy5L4q_4PKN2Gt-syH3n6MAYJOqXo",
      authDomain: "task-planner-f4dd7.firebaseapp.com",
      databaseURL: "https://task-planner-f4dd7-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "task-planner-f4dd7",
      storageBucket: "task-planner-f4dd7.firebasestorage.app",
      messagingSenderId: "321703356517",
      appId: "1:321703356517:web:8b0a2dc34e1587552bfe8c",
      measurementId: "G-64V5LHKLP8"
    };
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tasksRef = db.ref("tasks");

    // –í–∫–ª—é—á–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω-–ø–æ–¥–¥–µ—Ä–∂–∫—É
    firebase.database.enableLogging(false); // –º–æ–∂–Ω–æ true –¥–ª—è –¥–µ–±–∞–≥–∞
    db.setPersistence(true); // –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ñ–ª–∞–π–Ω

    let tasks = [];

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const LOCAL_STORAGE_KEY = "offline_tasks";

    function getOfflineTasks() {
      const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    }

    function saveOfflineTasks(data) {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
    }

    function mergeOfflineAndCloudTasks(cloudTasks) {
      const offlineTasks = getOfflineTasks();

      // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID
      const merged = [...cloudTasks, ...offlineTasks].reduce((acc, task) => {
        if (!acc.find(t => t.id === task.id)) acc.push(task);
        return acc;
      }, []);

      tasks = merged;
      saveTasksToCloud(); // –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –æ—Ñ–ª–∞–π–Ω-–∑–∞–¥–∞—á–∏
      clearOfflineTasks(); // –æ—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä
    }

    function saveTasksToCloud() {
      if (navigator.onLine) {
        const tasksMap = {};
        tasks.forEach(task => {
          tasksMap[task.id] = task;
        });
        tasksRef.set(tasksMap).catch(err => {
          console.warn("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:", err);
          saveOfflineTasks(tasks); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å
        });
      } else {
        saveOfflineTasks(tasks);
      }
    }

    function loadTasksFromCloud() {
      tasksRef.on("value", snapshot => {
        const data = snapshot.val();
        const cloudTasks = data ? Object.values(data) : [];

        mergeOfflineAndCloudTasks(cloudTasks);
        renderTasks();
      });
    }

    function addTask(title, time, category) {
      const newTask = {
        id: generateUniqueId(),
        title,
        time: time || null,
        category,
        done: false
      };
      tasks.push(newTask);
      saveTasksToCloud();
      setReminder(tasks.length - 1);
    }

    function deleteTask(index) {
      const id = tasks[index].id;
      tasks.splice(index, 1);
      if (navigator.onLine) {
        db.ref(`tasks/${id}`).remove();
      } else {
        saveOfflineTasks(tasks);
      }
    }

    function toggleDone(index) {
      tasks[index].done = !tasks[index].done;
      if (navigator.onLine) {
        db.ref(`tasks/${tasks[index].id}`).set(tasks[index]);
      } else {
        saveOfflineTasks(tasks);
      }
    }

    function clearCompleted() {
      tasks = tasks.filter(t => !t.done);
      if (navigator.onLine) {
        saveTasksToCloud();
      } else {
        saveOfflineTasks(tasks);
      }
    }

    function clearOfflineTasks() {
      localStorage.removeItem(LOCAL_STORAGE_KEY);
    }

    function generateUniqueId() {
      return Math.random().toString(36).substring(2, 10);
    }

    function setReminder(index) {
      const task = tasks[index];
      if (!task.time) return;

      const dueDate = new Date(task.time);
      const now = new Date();
      const timeUntilDue = dueDate.getTime() - now.getTime();

      if (timeUntilDue > 0 && timeUntilDue < 24 * 60 * 60 * 1000) {
        setTimeout(() => {
          showNotification(task.title);
        }, timeUntilDue - 5 * 60 * 1000); // –∑–∞ 5 –º–∏–Ω—É—Ç
      }
    }

    function showNotification(title) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", {
          body: `–ó–∞–¥–∞—á–∞ "${title}" —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç!`,
          icon: "icon-192.png"
        });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") {
            new Notification("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ", {
              body: `–ó–∞–¥–∞—á–∞ "${title}" —Å–∫–æ—Ä–æ –∏—Å—Ç–µ–∫–∞–µ—Ç!`,
              icon: "icon-192.png"
            });
          }
        });
      }
    }

    function renderTasks() {
      const statusFilter = document.getElementById("filter-status").value;
      const categoryFilter = document.getElementById("filter-category").value;

      const filteredTasks = tasks.filter(task => {
        let matchStatus = true;
        if (statusFilter === "completed") matchStatus = task.done;
        if (statusFilter === "active") matchStatus = !task.done;

        let matchCategory = true;
        if (categoryFilter !== "all") matchCategory = task.category === categoryFilter;

        return matchStatus && matchCategory;
      });

      const taskList = document.getElementById("task-list");
      taskList.innerHTML = "";
      filteredTasks.forEach((task, index) => {
        const now = new Date();
        const isOverdue = task.time && !task.done && new Date(task.time) < now;

        const li = document.createElement("li");
        li.className = task.done ? "completed" : isOverdue ? "overdue" : "";

        li.innerHTML = `
          <div class="task-title">${task.title}</div>
          <div class="task-time">
            ${task.time 
              ? 'üìÖ ' + new Date(task.time).toLocaleString() 
              : '<span class="task-no-deadline">–ë–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞</span>'
            }
          </div>
          <div class="task-category">üìÇ ${task.category}</div>
          <div class="actions">
            <label><input type="checkbox" class="checkbox" ${task.done ? "checked" : ""} /> –í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            <button onclick="deleteTask(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;

        li.querySelector(".checkbox").addEventListener("change", () => {
          toggleDone(index);
        });

        taskList.appendChild(li);
      });
    }

    const taskForm = document.getElementById("task-form");
    taskForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const titleInput = document.getElementById("task-title");
      const timeInput = document.getElementById("task-time");
      const categoryInput = document.getElementById("task-category");

      const title = titleInput.value.trim();
      const time = timeInput.value ? new Date(timeInput.value).toISOString() : null;
      const category = categoryInput.value;

      if (!title) return;

      addTask(title, time, category);

      titleInput.value = "";
      timeInput.value = "";
    });

    setInterval(renderTasks, 60000); // —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É

    // –¢–µ–º–∏–∑–∞—Ü–∏—è
    function toggleTheme() {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    window.addEventListener("load", () => {
      const theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.body.classList.add("dark");
      }
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    window.addEventListener("online", () => {
      console.log("–°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—Å—è...");
      saveTasksToCloud();
      loadTasksFromCloud();
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/task-planner/sw.js").then(registration => {
          console.log("Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", registration);
        }).catch(error => {
          console.log("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:", error);
        });
      });
    }

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    document.getElementById("filter-status").addEventListener("change", renderTasks);
    document.getElementById("filter-category").addEventListener("change", renderTasks);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadTasksFromCloud();
  </script>
</body>
</html>
